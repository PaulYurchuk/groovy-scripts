//Common variables section
def env = System.getenv()
def action = env['ACTION']
def repository = "project-releases"
def user = "nexus-service-user"
def password = "nexus"

//Authentication section
def basicAuth = "${user}:${password}".bytes.encodeBase64().toString()

switch (action){
  	case 'push':

	//Specific push variables section
 	def artifact = env['ARTIFACT_SUFFIX']
	def version = env['BUILD_NUMBER']
	def group = "${artifact}"
	def myFile = new File ("${artifact}-${version}.tar.gz").bytes
	def urlString = "http://192.168.56.104:8081/repository/${repository}/${group}/${artifact}/${version}/${artifact}-${version}.tar.gz"


	def url = new URL(urlString) 
	def connection = url.openConnection() 



	//Property section
	connection.setRequestProperty("Authorization", "Basic ${basicAuth}")
	connection.setRequestMethod("PUT")
	connection.setRequestProperty("Content-Type", "application/gzip");


	//Connect and output
	connection.doOutput = true 
	def writer = new DataOutputStream(connection.outputStream) 
	writer.write(myFile) 
	writer.flush() 
	writer.close() 
	connection.connect() 

	//Checks
	headerFields = connection.getHeaderFields() 
	headerFields.each {println it} 

  	break
      
	case 'pull':

	//Specific pull variables section
	def ARTIFACT_NAME = env['ARTIFACT_NAME']
	def index = ARTIFACT_NAME.lastIndexOf("-")
	def extIndex = ARTIFACT_NAME.indexOf(".")
	def artifact = ARTIFACT_NAME.substring(0, index )
	def version = ARTIFACT_NAME.substring(index+1, extIndex)
	def group = "${artifact}"
	def urlString = "http://192.168.56.104:8081/repository/${repository}/${group}/${artifact}/${version}/${artifact}-${version}.tar.gz"
	println urlString
  
	//Pull process
	new File("$ARTIFACT_NAME").withOutputStream { Stream ->
		def url = new URL(urlString) 
		def connection = url.openConnection() 
		connection.setRequestProperty("Authorization", "Basic ${basicAuth}")
    	url.withInputStream{ download -> Stream << download }
		}
	
  	break
  	
    default:
      	println 'Specify push or pull request'
		break
}
