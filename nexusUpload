//Variables section
def env = System.getenv()

def action = env['ACTION']
def repository = "project-releases"
def user = "nexus-service-user"
def password = "nexus"


if("$action"=="push"){
 	def artifact = env['ARTIFACT_SUFFIX']
	def version = env['BUILD_NUMBER']
	def group = "${artifact}"
	def myFile = new File ("${artifact}-${version}.tar.gz").bytes
	def urlString = "http://192.168.56.104:8081/repository/${repository}/${group}/${artifact}/${version}/${artifact}-${version}.tar.gz"


	def url = new URL(urlString) 
	def connection = url.openConnection() 

	//Authentication section
	def basicAuth = "${user}:${password}".bytes.encodeBase64().toString()

	//Property section
	connection.setRequestProperty("Authorization", "Basic ${basicAuth}")
	connection.setRequestMethod("PUT")
	connection.setRequestProperty("Content-Type", "application/gzip");


	//Connect and output
	connection.doOutput = true 
	def writer = new DataOutputStream(connection.outputStream) 
	writer.write(myFile) 
	writer.flush() 
	writer.close() 
	connection.connect() 

	//Checks
	headerFields = connection.getHeaderFields() 
	headerFields.each {println it} 

} else {

def x = env['ARTIFACT_NAME']
def index = x.indexOf("-")
def extIndex = x.indexOf(".")
def artifact = x.substring(0, index )
def version = x.substring(index+1, extIndex)
def extension = x.substring(extIndex+1)

}
